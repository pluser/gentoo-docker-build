name: Build and Publish Gentoo Docker image

on: release

jobs:
  build_push_gentoo-amd64:
    name: gentoo-amd64
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: Build and Push to GitHub Packages
        uses: docker/build-push-action@v1
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: docker.pkg.github.com
          repository: pluser/gentoo-docker-build-by-github/gentoo-amd64
          tag_with_ref: true

  build_push_stage3-amd64-systemd:
    name: stage3-amd64-systemd
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
        with:
          repository:  gentoo/gentoo-docker-images 
          path: official
      - name: Build the image
        env:
          TARGET: stage3-amd64-systemd
        run: ./build.sh
        shell: bash
        working-directory: ./official
      - name: Push to GitHub Packages
        env:
          IMAGE_ID: stage3-amd64-systemd
          ORG: gentoo
          REGISTORY: docker.pkg.github.com
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${REGISTORY} -u ${{ github.actor }} --password-stdin
          IMAGE_ID=${REGISTORY}/${{ github.repository }}/${IMAGE_NAME}
          docker push ${ORG}/${IMAGE_ID}:latest
        shell: bash

  build_push_gentoo-amd64-systemd:
    name: gentoo-am64-systemd
    needs: build_push_stage3-amd64-systemd
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: Push to GitHub Packages
        uses: docker/build-push-action@v1
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: docker.pkg.github.com
          repository: pluser/gentoo-docker-build-by-github/gentoo-amd64-systemd
          tag_with_ref: true
